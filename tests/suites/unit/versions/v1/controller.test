#!/bin/sh

Include "$SOURCE_DIRECTORY/versions/v1/controller"

SOME_GLOBAL_TASK="some_global_task"
SOME_GLOBAL_TASK_FILE_PATH="$SOURCE_DIRECTORY/versions/v1/tasks/$SOME_GLOBAL_TASK"
SOME_LOCAL_TASK="some_local_task"
SOME_LOCAL_TASK_FILE_PATH="$KANO_LOCAL_DIRECTORY/tasks/$SOME_LOCAL_TASK"
SOME_PARAMETER_1="param1"
SOME_PARAMETER_2="param2"

Describe "controller"
  fail() {
    # shellcheck disable=SC2034
    fail_called_with="$*"
    %preserve fail_called_with
    exit 1
  }

  does_directory_exist() {
    if [ "$1" = "$KANO_LOCAL_DIRECTORY" ]; then
      "$DOES_LOCAL_DIRECTORY_EXIST"
    else
      false
    fi
  }

  does_file_exist() {
    if [ "$1" = "$SOME_GLOBAL_TASK_FILE_PATH" ]; then
      "$DOES_GLOBAL_TASK_FILE_EXIST"

    elif [ "$1" = "$KANO_LOCAL_PROJECT_FILE" ]; then
      "$DOES_LOCAL_PROJECT_FILE_EXIST"

    elif [ "$1" = "$SOME_LOCAL_TASK_FILE_PATH" ]; then
      "$DOES_LOCAL_TASK_FILE_EXIST"

    elif [ "$1" = "$KANO_LOCAL_ENVIRONMENT_FILE" ]; then
      "$DOES_LOCAL_ENVIRONMENT_FILE_EXIST"

    else
      false
    fi
  }

  _import() {
    if [ -n "$import_called_with" ]; then
      import_called_with="$import_called_with|$*"

    else
      import_called_with="$*"
    fi

    %preserve import_called_with
  }

  DOES_GLOBAL_TASK_FILE_EXIST=false
  DOES_LOCAL_DIRECTORY_EXIST=false
  DOES_LOCAL_PROJECT_FILE_EXIST=false
  DOES_LOCAL_TASK_FILE_EXIST=false
  DOES_LOCAL_ENVIRONMENT_FILE_EXIST=false

  Describe "execute_global"
    Context "when task does not exist globally"
      It "should fail with the expected error message"
        When run controller execute_global "$SOME_GLOBAL_TASK"
        The status should be failure
        The variable fail_called_with should eq "No global task named '$SOME_GLOBAL_TASK'"
      End
    End

    Context "when task exists globally"
      DOES_GLOBAL_TASK_FILE_EXIST=true
      eval "$SOME_GLOBAL_TASK() {
        task_called_with=\"\$*\"
        %preserve task_called_with
      }"

      It "should execute global task"
        When run controller execute_global "$SOME_GLOBAL_TASK" "$SOME_PARAMETER_1" "$SOME_PARAMETER_2"
        The status should be success
        The variable import_called_with should include "$SOME_GLOBAL_TASK_FILE_PATH"
        The variable task_called_with should eq "$SOME_PARAMETER_1 $SOME_PARAMETER_2"
      End
    End
  End

  Describe "execute_local"
    Context "when local kano directory does not exist"
      It "should fail with the expected error message"
        When run controller execute_local "$SOME_LOCAL_TASK"
        The status should be failure
        The variable fail_called_with should eq "No local kano directory found at '$KANO_LOCAL_DIRECTORY'"
      End
    End

    Context "when local kano directory exists"
      DOES_LOCAL_DIRECTORY_EXIST=true
      Context "when kano project file does not exist"
        It "should fail with the expected error message"
          When run controller execute_local "$SOME_LOCAL_TASK"
          The status should be failure
          The variable fail_called_with should eq "No kano project file found at '$KANO_LOCAL_PROJECT_FILE'"
        End
      End

      Context "when local kano project file exists"
        DOES_LOCAL_PROJECT_FILE_EXIST=true
        Context "when task does not exist locally"
          It "should fail with the expected error message"
            When run controller execute_local "$SOME_LOCAL_TASK"
            The status should be failure
            The variable fail_called_with should eq "No local task named '$SOME_LOCAL_TASK'"
          End
        End

        Context "when task exists locally"
          DOES_LOCAL_TASK_FILE_EXIST=true
          Context "when task is not correctly defined"
            It "should fail with the expected error message"
              When run controller execute_local "$SOME_LOCAL_TASK"
              The status should be failure
              The variable fail_called_with should eq \
                "Local task '$SOME_LOCAL_TASK' was not properly defined in '$SOME_LOCAL_TASK_FILE_PATH'"
            End
          End

          Context "when task is correctly defined"
            eval "$SOME_LOCAL_TASK() {
              task_called_with=\"\$*\"
              %preserve task_called_with
            }"

            It "should execute local task"
              When run controller execute_local "$SOME_LOCAL_TASK" "$SOME_PARAMETER_1" "$SOME_PARAMETER_2"
              The status should be success
              The variable import_called_with should include "$SOME_LOCAL_TASK_FILE_PATH"
              The variable task_called_with should eq "$SOME_PARAMETER_1 $SOME_PARAMETER_2"
            End

            Context "when a local environment file is present"
              DOES_LOCAL_ENVIRONMENT_FILE_EXIST=true
              It "should import the local environment file"
                When run controller execute_local "$SOME_LOCAL_TASK" "$SOME_PARAMETER_1" "$SOME_PARAMETER_2"
                The status should be success
                The variable import_called_with should include "$KANO_LOCAL_ENVIRONMENT_FILE"
              End
            End
          End
        End
      End
    End
  End
End
