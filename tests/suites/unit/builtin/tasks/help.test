#!/bin/sh

Include "$SOURCE_DIRECTORY/builtin/tasks/help"

SOME_PROJECT_TASK="some_project_task"
SOME_PROJECT_TASK_HELP_MESSAGE="some_project_task_help_message"
SOME_USER_TASK="some_user_task"
SOME_USER_TASK_HELP_MESSAGE="some_user_task_help_message"
SOME_SYSTEM_TASK="some_system_task"
SOME_SYSTEM_TASK_HELP_MESSAGE="some_system_task_help_message"
SOME_BUILTIN_TASK="some_builtin_task"
SOME_BUILTIN_TASK_HELP_MESSAGE="some_builtin_task_help_message"

Describe "help"
  report() {
    if [ -n "$report_called_with" ]; then
      report_called_with="$report_called_with|$*"

    else
      report_called_with="$*"
    fi

    %preserve report_called_with
  }

  does_directory_exist() {
    if [ "$1" = "$KANO_PROJECT_DIRECTORY/tasks" ]; then
      "$DOES_PROJECT_TASK_DIRECTORY_EXIST"

    elif [ "$1" = "$KANO_USER_DIRECTORY/tasks" ]; then
      "$DOES_USER_TASK_DIRECTORY_EXIST"

    elif [ "$1" = "$KANO_SYSTEM_DIRECTORY/tasks" ]; then
      "$DOES_SYSTEM_TASK_DIRECTORY_EXIST"

    else
      false
    fi
  }

  list_files_in_directory() {
    if [ "$1" = "$KANO_PROJECT_DIRECTORY/tasks" ]; then
      echo "$SOME_PROJECT_TASK"

    elif [ "$1" = "$KANO_USER_DIRECTORY/tasks" ]; then
      echo "$SOME_USER_TASK"

    elif [ "$1" = "$KANO_SYSTEM_DIRECTORY/tasks" ]; then
      echo "$SOME_SYSTEM_TASK"

    elif [ "$1" = "$KANO_BUILTIN_DIRECTORY/tasks" ]; then
      echo "$SOME_BUILTIN_TASK"

    else
      return
    fi
  }

  awk() {
    true
  }

  _import() {
    true
  }

  eval "${SOME_BUILTIN_TASK}_help() {
    echo \"$SOME_BUILTIN_TASK_HELP_MESSAGE\"
  }"

  DOES_PROJECT_TASK_DIRECTORY_EXIST=false
  DOES_USER_TASK_DIRECTORY_EXIST=false
  DOES_SYSTEM_TASK_DIRECTORY_EXIST=false

  Describe "help"
    It "shows the task help message"
      When run help_help
      The status should be success
      The output should equal "Show this help message"
    End
  End

  Describe "task"
    Context "when no tasks are defined in any scope"
      It "should only list builtin tasks section"
        When run help
        The status should be success
        The variable report_called_with should not include "Project tasks"
        The variable report_called_with should not include "User tasks"
        The variable report_called_with should not include "System tasks"
        The variable report_called_with should include "Builtin tasks"
      End

      It "should show builtin tasks help messages"
        When run help
        The status should be success
        The variable report_called_with should include "$SOME_BUILTIN_TASK"
        The variable report_called_with should include "$SOME_BUILTIN_TASK_HELP_MESSAGE"
      End
    End

    Context "when tasks are defined in project scope"
      DOES_PROJECT_TASK_DIRECTORY_EXIST=true
      It "should list project tasks section"
        When run help
        The status should be success
        The variable report_called_with should include "Project tasks"
      End

      Context "when project task has no help message"
        It "should display '-' as help message instead"
          When run help
          The status should be success
          The variable report_called_with should include "$SOME_PROJECT_TASK"
          The variable report_called_with should include "-"
        End
      End

      Context "when system task has a help message"
        eval "${SOME_PROJECT_TASK}_help() {
          echo \"$SOME_PROJECT_TASK_HELP_MESSAGE\"
        }"

        It "should display the help message"
          When run help
          The status should be success
          The variable report_called_with should include "$SOME_PROJECT_TASK"
          The variable report_called_with should include "$SOME_PROJECT_TASK_HELP_MESSAGE"
        End
      End
    End

    Context "when tasks are defined in user scope"
      DOES_USER_TASK_DIRECTORY_EXIST=true
      It "should list user tasks section"
        When run help
        The status should be success
        The variable report_called_with should include "User tasks"
      End

      Context "when user task has no help message"
        It "should display '-' as help message instead"
          When run help
          The status should be success
          The variable report_called_with should include "$SOME_USER_TASK"
          The variable report_called_with should include "-"
        End
      End

      Context "when user task has a help message"
        eval "${SOME_USER_TASK}_help() {
          echo \"$SOME_USER_TASK_HELP_MESSAGE\"
        }"

        It "should display the help message"
          When run help
          The status should be success
          The variable report_called_with should include "$SOME_USER_TASK"
          The variable report_called_with should include "$SOME_USER_TASK_HELP_MESSAGE"
        End
      End
    End

    Context "when tasks are defined in system scope"
      DOES_SYSTEM_TASK_DIRECTORY_EXIST=true
      It "should list sytem tasks section"
        When run help
        The status should be success
        The variable report_called_with should include "System tasks"
      End

      Context "when system task has no help message"
        It "should display '-' as help message instead"
          When run help
          The status should be success
          The variable report_called_with should include "$SOME_SYSTEM_TASK"
          The variable report_called_with should include "-"
        End
      End

      Context "when system task has a help message"
        eval "${SOME_SYSTEM_TASK}_help() {
          echo \"$SOME_SYSTEM_TASK_HELP_MESSAGE\"
        }"

        It "should display the help message"
          When run help
          The status should be success
          The variable report_called_with should include "$SOME_SYSTEM_TASK"
          The variable report_called_with should include "$SOME_SYSTEM_TASK_HELP_MESSAGE"
        End
      End
    End

    Context "when tasks are defined in all scopes"
      DOES_PROJECT_TASK_DIRECTORY_EXIST=true
      DOES_USER_TASK_DIRECTORY_EXIST=true
      DOES_SYSTEM_TASK_DIRECTORY_EXIST=true
      It "should list all tasks section"
        When run help
        The status should be success
        The variable report_called_with should include "Project tasks"
        The variable report_called_with should include "User tasks"
        The variable report_called_with should include "System tasks"
        The variable report_called_with should include "Builtin tasks"
      End
    End
  End
End
